<?xml version="1.0" encoding="UTF-8"?>
<project>
  <actions/>
  <description>Run upgrade on the selected cloud
Useful only for cloud that was built by mkcloud.
This job is making use of mkcloud.config file stored on admin node which contains
configuration values used from the jenkins cloud scenario

Mandatory parameter: hw_number
&lt;!-- Managed by Jenkins Job Builder --&gt;</description>
  <logRotator class="hudson.tasks.LogRotator">
    <daysToKeep>-1</daysToKeep>
    <numToKeep>15</numToKeep>
    <artifactDaysToKeep>-1</artifactDaysToKeep>
    <artifactNumToKeep>-1</artifactNumToKeep>
  </logRotator>
  <keepDependencies>false</keepDependencies>
  <properties>
    <hudson.model.ParametersDefinitionProperty>
      <parameterDefinitions>
        <hudson.model.StringParameterDefinition>
          <name>hw_number</name>
          <description>Mandatory, number of the QA cloud server</description>
          <defaultValue/>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>upgrade_cloudsource</name>
          <description>Mandatory, mkcloud cloudsource target name, e.g. develcloud7</description>
          <defaultValue>develcloud7</defaultValue>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>scenario_name</name>
          <description>Optional; scenario name which typically is an integer with a single letter</description>
          <defaultValue/>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>scenario_job_name</name>
          <description>Optional; name of the scenario jenkins job that is used to trigger this job</description>
          <defaultValue/>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>scenario_build_number</name>
          <description>Optional; scenario build number that triggered this job</description>
          <defaultValue/>
        </hudson.model.StringParameterDefinition>
        <hudson.model.StringParameterDefinition>
          <name>scenario_build_number</name>
          <description>Optional; scenario build number that triggered this job</description>
          <defaultValue/>
        </hudson.model.StringParameterDefinition>
      </parameterDefinitions>
    </hudson.model.ParametersDefinitionProperty>
  </properties>
  <scm class="hudson.scm.NullSCM"/>
  <assignedNode>cloud-mkphyscloud-gate-qa</assignedNode>
  <canRoam>false</canRoam>
  <disabled>false</disabled>
  <blockBuildWhenDownstreamBuilding>false</blockBuildWhenDownstreamBuilding>
  <blockBuildWhenUpstreamBuilding>false</blockBuildWhenUpstreamBuilding>
  <triggers/>
  <concurrentBuild>true</concurrentBuild>
  <builders>
    <hudson.tasks.Shell>
      <command>#!/bin/bash
admin=crowbar$hw_number;
cloud=qa$hw_number;
result=0

artifacts_dir=$WORKSPACE/.artifacts
rm -rf $artifacts_dir
mkdir -p $artifacts_dir
touch $artifacts_dir/.ignore

ssh root@$admin "
  export cloud=$cloud;
  export upgrade_cloudsource=$upgrade_cloudsource
  export cct_ui_tests=true
" '
  set -x;
  hostname -f;
  source mkcloud.config;
  source scripts/qa_crowbarsetup.sh;

  [[ -z $upgrade_cloudsource ]] &amp;&amp; \
  complain 55 "Variable \$upgrade_cloudsource not defined, upgrade target is missing"

  zypper refresh
  zypper update
  zypper --non-interactive install crowbar-ui

  # from scripts/mkcloud -&gt; crowbarupgrade_5plus
  onadmin_zypper_patch_all
  onadmin_allow_vendor_change_at_nodes

  export cct_tests=feature:ui:upgrade:landing+feature:ui:upgrade:admin:backup
  onadmin_run_cct

  export cloudsource=$upgrade_cloudsource
  onadmin_prepare_cloudupgrade_repos_6_to_7

  export cct_tests=feature:ui:upgrade:admin:repos
  onadmin_run_cct
' || result=$?

scp root@$admin:/root/github.com/SUSE-Cloud/cct/*.png $artifacts_dir

exit $result
</command>
    </hudson.tasks.Shell>
  </builders>
  <publishers>
    <hudson.tasks.ArtifactArchiver>
      <artifacts>.artifacts/**</artifacts>
      <allowEmptyArchive>true</allowEmptyArchive>
      <onlyIfSuccessful>false</onlyIfSuccessful>
      <fingerprint>false</fingerprint>
      <defaultExcludes>true</defaultExcludes>
      <caseSensitive>true</caseSensitive>
    </hudson.tasks.ArtifactArchiver>
  </publishers>
  <buildWrappers>
    <org.jenkinsci.plugins.buildnamesetter.BuildNameSetter plugin="build-name-setter@">
      <template>#${BUILD_NUMBER} - ${scenario_name} - qa$hw_number - upgrade-ui</template>
      <runAtStart>true</runAtStart>
      <runAtEnd>true</runAtEnd>
    </org.jenkinsci.plugins.buildnamesetter.BuildNameSetter>
    <hudson.plugins.timestamper.TimestamperBuildWrapper plugin="timestamper@"/>
  </buildWrappers>
</project>
